<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>民視政治組排班表</title>
    
    <link rel="icon" href="data:,">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://esm.sh/firebase@10.12.2/app",
        "firebase/auth": "https://esm.sh/firebase@10.12.2/auth",
        "firebase/firestore": "https://esm.sh/firebase@10.12.2/firestore"
      }
    }
    </script>

    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react,env">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Download, Trash2, Users, Cloud, CloudOff, Calendar, Lock, Unlock, X, Check, AlertTriangle, Settings, Plus, Minus, GripVertical, ChevronUp, ChevronDown, Clock, Info, Plane, Save, HardDrive, History } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, enableNetwork, disableNetwork } from 'firebase/firestore';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJ_b9BiX1zT7WFu8f08uoKxeV8vgDUHz4",
            authDomain: "fuktrip.firebaseapp.com",
            projectId: "fuktrip",
            storageBucket: "fuktrip.firebasestorage.app",
            messagingSenderId: "663462561018",
            appId: "1:663462561018:web:d0c9f00c9fed0253a2b543",
            measurementId: "G-KME94X3EKH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Use a fixed global ID for this specific app instance to share data
        const APP_ID = 'political-schedule-v1'; 
        const COLLECTION_NAME = 'schedules';
        const DOC_ID = 'main';
        const LOCAL_STORAGE_KEY = 'political_schedule_backup';

        // --- UI Components ---
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200 flex flex-col max-h-[90vh]">
                        <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100 bg-gray-50 flex-shrink-0">
                            <h3 className="font-bold text-gray-700">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors">
                                <X size={20} />
                            </button>
                        </div>
                        <div className="p-4 overflow-y-auto flex-1">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const PoliticalGroupSchedule = () => {
            // --- State Definitions ---
            
            // 1. 人員名單 (預設名單)
            const DEFAULT_STAFF = [
                '陳妍伶', '吳承翰', '林靜', '林秀宜', '楊凱安', '林彥君', '屈道昀', '王云宣'
            ];
            const [staffList, setStaffList] = useState(DEFAULT_STAFF);

            // 選項定義
            const OPTIONS = ['', '休', '夜', '休播', '年', '補', 'X'];

            // 2. 時間與使用者狀態
            const today = new Date();
            // 計算下個月
            const nextMonthDate = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            
            const [year, setYear] = useState(nextMonthDate.getFullYear());
            const [month, setMonth] = useState(nextMonthDate.getMonth() + 1);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [syncStatus, setSyncStatus] = useState('idle'); // idle, syncing, saved, error, offline
            const [lastUpdated, setLastUpdated] = useState(null); // 最後更新時間
            
            // Offline Mode State
            const [isOfflineMode, setIsOfflineMode] = useState(false);
            const isOfflineRef = useRef(false);

            // Modals State
            const [showUnlockModal, setShowUnlockModal] = useState(false);
            const [unlockPassword, setUnlockPassword] = useState('');
            const [unlockError, setUnlockError] = useState('');
            const [showClearModal, setShowClearModal] = useState(false);
            const [showHelpModal, setShowHelpModal] = useState(false);
            
            // Staff Management Modals
            const [showStaffAuthModal, setShowStaffAuthModal] = useState(false);
            const [showStaffManagerModal, setShowStaffManagerModal] = useState(false);
            const [staffAuthPassword, setStaffAuthPassword] = useState('');
            const [staffAuthError, setStaffAuthError] = useState('');
            const [newStaffName, setNewStaffName] = useState('');
            
            // History Logs Modal
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [showHistoryAuthModal, setShowHistoryAuthModal] = useState(false);
            const [historyAuthPassword, setHistoryAuthPassword] = useState('');
            const [historyAuthError, setHistoryAuthError] = useState('');

            // Overseas Modal
            const [showOverseasModal, setShowOverseasModal] = useState(false);
            const [overseasPerson, setOverseasPerson] = useState('');
            const [overseasStartDate, setOverseasStartDate] = useState('');
            const [overseasEndDate, setOverseasEndDate] = useState('');
            
            // Drag and Drop State
            const [draggedIndex, setDraggedIndex] = useState(null);

            // Member Lock State
            const [memberLocks, setMemberLocks] = useState({});
            const [showMemberLockModal, setShowMemberLockModal] = useState(false);
            const [targetMember, setTargetMember] = useState(null);
            const [memberLockPassword, setMemberLockPassword] = useState('');
            const [isSettingLock, setIsSettingLock] = useState(false); 

            // 3. 資料狀態
            const [scheduleData, setScheduleData] = useState({});
            const [requirements, setRequirements] = useState({}); 
            const [darkenedDays, setDarkenedDays] = useState({});
            const [overseasData, setOverseasData] = useState({});
            const [historyLogs, setHistoryLogs] = useState([]);
            
            const [lockedMonths, setLockedMonths] = useState({}); 
            const [deadlines, setDeadlines] = useState({});
            const [shouldLeaveDaysMap, setShouldLeaveDaysMap] = useState({});
            const [actualLeaveDaysMap, setActualLeaveDaysMap] = useState({});

            // --- Refs for Debouncing ---
            const pendingUpdates = useRef({});
            const saveTimeout = useRef(null);

            // --- Derived State (Current Month) ---
            const currentMonthKey = `${year}-${month}`;
            const isLocked = lockedMonths[currentMonthKey] || false;
            const currentDeadline = deadlines[currentMonthKey] || '';
            const currentShouldLeave = shouldLeaveDaysMap[currentMonthKey] || '';
            const currentActualLeave = actualLeaveDaysMap[currentMonthKey] || '';

            // --- Helper: Add Log ---
            const addLog = (content) => {
                const timestamp = new Date().toISOString();
                const newLog = { timestamp, content };
                // Update local state immediately
                setHistoryLogs(prev => [newLog, ...prev].slice(0, 100)); // Keep last 100 logs
                
                // Trigger save
                const newLogsArray = [newLog, ...historyLogs].slice(0, 100);
                saveToFirebaseDebounced({ historyLogs: newLogsArray });
            };

            // Helper to activate offline mode
            const activateOfflineMode = () => {
                if (isOfflineRef.current) return;
                console.warn("Activating Offline Mode due to quota or connection error.");
                isOfflineRef.current = true;
                setIsOfflineMode(true);
                setSyncStatus('offline');
                
                try {
                    disableNetwork(db);
                } catch(e) {
                    console.error("Could not disable network", e);
                }
                
                loadFromLocalStorage();
            };

            // --- Local Storage Logic ---
            const loadFromLocalStorage = () => {
                try {
                    const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        setScheduleData(parsed.schedule || {});
                        setRequirements(parsed.requirements || {});
                        setDarkenedDays(parsed.darkenedDays || {});
                        setOverseasData(parsed.overseasData || {});
                        setLockedMonths(parsed.lockedMonths || {});
                        setDeadlines(parsed.deadlines || {});
                        setShouldLeaveDaysMap(parsed.shouldLeaveDaysMap || {});
                        setActualLeaveDaysMap(parsed.actualLeaveDaysMap || {});
                        setMemberLocks(parsed.memberLocks || {});
                        setHistoryLogs(parsed.historyLogs || []);
                        if (parsed.staffList) setStaffList(parsed.staffList);
                        setLastUpdated(parsed.lastUpdated || new Date().toISOString());
                        console.log("Loaded data from Local Storage");
                    }
                } catch (e) {
                    console.error("Failed to load from localStorage", e);
                }
                setLoading(false);
            };

            useEffect(() => {
                if (isOfflineMode) {
                    const dataToSave = {
                        schedule: scheduleData,
                        requirements,
                        darkenedDays,
                        overseasData,
                        lockedMonths,
                        deadlines,
                        shouldLeaveDaysMap,
                        actualLeaveDaysMap,
                        staffList,
                        memberLocks,
                        historyLogs,
                        lastUpdated: new Date().toISOString()
                    };
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
                    setLastUpdated(dataToSave.lastUpdated);
                }
            }, [scheduleData, requirements, darkenedDays, overseasData, lockedMonths, deadlines, shouldLeaveDaysMap, actualLeaveDaysMap, staffList, memberLocks, historyLogs, isOfflineMode]);

            // --- Firebase Logic ---

            // Auth Initialization
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth error:", error);
                        activateOfflineMode();
                    }
                };
                initAuth();

                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                });
                return () => unsubscribe();
            }, []);

            // Data Synchronization
            useEffect(() => {
                if (!user || isOfflineMode) return;

                const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', COLLECTION_NAME, DOC_ID);

                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    setLoading(false);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setScheduleData(data.schedule || {});
                        setRequirements(data.requirements || {});
                        setDarkenedDays(data.darkenedDays || {});
                        setOverseasData(data.overseasData || {});
                        
                        setLockedMonths(data.lockedMonths || {});
                        setDeadlines(data.deadlines || {});
                        setShouldLeaveDaysMap(data.shouldLeaveDaysMap || {});
                        setActualLeaveDaysMap(data.actualLeaveDaysMap || {});
                        
                        setMemberLocks(data.memberLocks || {});
                        setHistoryLogs(data.historyLogs || []);
                        setLastUpdated(data.lastUpdated || null);
